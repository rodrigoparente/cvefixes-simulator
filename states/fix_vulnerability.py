# third-party imports
import pandas as pd

# project imports
from commons.stats import get_stats

# local imports
from .constants import FIX_VULNERABILITY
from .constants import ERROR_STATE
from .constants import END_STATE


def fix_vulnerability(env):

    current_rep = env['current_rep']
    vulns_to_fix = env['fix_vulns_per_rep']

    if current_rep == env['rep'] + 1:
        del env['current_rep']
        return (END_STATE, env)

    cvss_sorted = env['iterations']['cvss_sorted']
    frape_sorted = env['iterations']['frape_sorted']

    if len(cvss_sorted) < vulns_to_fix:
        env = {**env, 'errors': ['Not enough vulnerabilities to fix.']}
        return (ERROR_STATE, env)

    cvss_sorted = cvss_sorted[vulns_to_fix:]
    frape_sorted = frape_sorted[vulns_to_fix:]

    df = pd.DataFrame.from_records(env['vulnerabilities'])

    cvss_df = df.loc[df['cve_id'].isin(cvss_sorted)]
    frape_df = df.loc[df['cve_id'].isin(frape_sorted)]

    cvss_stats = env['iterations']['cvss_stats']
    frape_stats = env['iterations']['frape_stats']

    env['current_rep'] += 1

    env = {
        **env,
        'iterations': {
            'cvss_sorted': cvss_sorted,
            'frape_sorted': frape_sorted,
            'cvss_stats': [*cvss_stats, get_stats(cvss_df)],
            'frape_stats': [*frape_stats, get_stats(frape_df)]
        }
    }

    return (FIX_VULNERABILITY, env)
