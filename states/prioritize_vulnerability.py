# python imports
import pandas as pd

# project imports
from commons.data import get_stats

# local imports
from .constants import FIX_VULNERABILITY


def prioritize_vulnerability(env):

    df = pd.DataFrame.from_records(env['vulnerabilities'])

    df['risk_score'] = pd.Categorical(
        df.risk_score, categories=['LOW', 'MODERATE', 'IMPORTANT', 'CRITICAL'], ordered=True)

    cvss_sorted = df.sort_values(by=['base_score'], ascending=False)
    cvss_sorted = cvss_sorted['cve_id'].tolist()

    frape_sorted = df.sort_values(by=['risk_score', 'risk_proba'], ascending=[False, False])
    frape_sorted = frape_sorted['cve_id'].tolist()

    env = {
        **env,
        'iterations': {
            0: {
                'cvss_sorted': cvss_sorted,
                'frape_sorted': frape_sorted,
                'stats_cvss': get_stats(df),
                'stats_frape': get_stats(df),
            }
        }
    }

    return (FIX_VULNERABILITY, env)
